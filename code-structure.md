# Δομή κώδικα

Οι ερωτήσεις που σχετίζονται με τη δομή του κώδικα της Terraform είναι μακράν οι πιο συχνές στην κοινότητα. Όλοι σκέφτηκαν επίσης κάποια στιγμή για την καλύτερη δομή κώδικα για το έργο.

## Πώς προτείνεται να δομώ τις Terraform ρυθμίσεις μου;

Αυτή είναι μία από τις ερωτήσεις όπου υπάρχουν πολλές πιθανές λύσεις και είναι πολύ δύσκολο να δώσουμε γενικές οδηγίες, οπότε ας ξεκινήσουμε με την κατανόηση του τι αντιμετωπίζουμε.

* Ποια είναι η πολυπλοκότητα του έργου σας;
  * Αριθμός σχετικών πόρων
  * Αριθμός παρόχων Terraform (βλ. σημείωση παρακάτω σχετικά με τους "λογικούς παρόχους")
* Πόσο συχνά αλλάζει η υποδομή σας;
  * **Από** μία φορά το μήνα/εβδομάδα/ημέρα
  * **Μέχρι** συνεχώς (κάθε φορά που υπάρχει ένα νέο commit)
* Εναύσματα αλλαγής κώδικα; _Αφήνετε τον CI server να ενημερώνει το repository όταν κατασκευάζεται ένα νέο artifact;_
  * Μόνο οι προγραμματιστές μπορούν να κάνουν push στο repository υποδομής
  * Όλοι μπορούν να προτείνουν μια αλλαγή σε ο,τιδήποτε ανοίγοντας ένα PR (συμπεριλαμβανομένων των αυτοματοποιημένων εργασιών που εκτελούνται στον CI server)
* Ποια πλατφόρμα ανάπτυξης ή υπηρεσία ανάπτυξης χρησιμοποιείτε;
  * Το AWS CodeDeploy, το Kubernetes ή το OpenShift απαιτούν μια ελαφρώς διαφορετική προσέγγιση
* Πώς ομαδοποιούνται τα περιβάλλοντα;
  * Ανά περιβάλλον, περιοχή, έργο

{% hint style="info" %}
Οι _λογικοί πάροχοι_ λειτουργούν εξ ολοκλήρου εντός της λογικής του Terraform και πολύ συχνά δεν αλληλεπιδρούν με άλλες υπηρεσίες, οπότε μπορούμε να σκεφτούμε την πολυπλοκότητά τους ως O(1). Οι πιο συνηθισμένοι λογικοί πάροχοι περιλαμβάνουν τις [random](https://registry.terraform.io/providers/hashicorp/random/latest/docs), [local](https://registry.terraform.io/providers/hashicorp/local/latest/docs), [terraform](https://www.terraform.io/docs/providers/terraform/index.html), [null](https://registry.terraform.io/providers/hashicorp/null/latest/docs), [time](https://registry.terraform.io/providers/hashicorp/time/latest).
{% endhint %}

## Ξεκινώντας με τη δόμηση των ρυθμίσεων της Terraform

Η τοποθέτηση όλου του κώδικα στο `main.tf` είναι μια καλή ιδέα όταν ξεκινάτε ή όταν γράφετε ένα παράδειγμα κώδικα. Σε όλες τις άλλες περιπτώσεις θα είναι καλύτερα να έχετε διάφορα αρχεία χωρισμένα λογικά όπως αυτό:

* `main.tf` - κλήση μονάδων, τοπικών μονάδων και πηγών δεδομένων για τη δημιουργία όλων των πόρων
* `variables.tf` - περιέχει δηλώσεις των μεταβλητών που χρησιμοποιούνται στο main.tf
* `outputs.tf` - περιέχει τα outpus από τους πόρους που δημιουργήθηκαν στο main.tf
* `versions.tf` - περιέχει απαιτήσεις versioning για το Terraform και τους παρόχους

Το `terraform.tfvars` δεν πρέπει να χρησιμοποιείται πουθενά αλλού εκτός από [τη σύνθεση](key-concepts.md#composition)

## Πώς να σκεφτείτε τη δομή ρυθμίσεων του Terraform;

{% hint style="info" %}
Βεβαιωθείτε ότι έχετε κατανοήσει τις βασικές έννοιες - [μονάδα πόρου](key-concepts.md#resource-module), [μονάδα υποδομής](key-concepts.md#infrastructure-module) και [σύνθεση](key-concepts.md#composition), όπως χρησιμοποιούνται στα παρακάτω παραδείγματα.
{% endhint %}

### Κοινές συστάσεις για τη δόμηση του κώδικα

* Είναι ευκολότερο και γρηγορότερο να εργάζεστε με μικρότερο αριθμό πόρων
  * Το `terraform plan` και το `terraform apply` πραγματοποιούν και τα δύο κλήσεις cloud API για να επαληθεύσουν την κατάσταση των πόρων
  * Εάν έχετε ολόκληρη την υποδομή σας σε μία μόνο σύνθεση αυτό μπορεί να πάρει αρκετό χρόνο
* Η ακτίνα επίδρασης (σε περίπτωση παραβίασης της ασφάλειας) είναι μικρότερη με λιγότερους πόρους
  * Η απομόνωση μη συνδεδεμένων πόρων μεταξύ τους με την τοποθέτησή τους σε ξεχωριστές συνθέσεις μειώνει τον κίνδυνο αν κάτι πάει στραβά
* Ξεκινήστε το έργο σας χρησιμοποιώντας απομακρυσμένη κατάσταση επειδή:
  * Ο φορητός σας υπολογιστής δεν είναι κατάλληλο μέρος για την «πηγή αλήθειας» της υποδομής σας
  * Η διαχείριση ενός αρχείου `tfstate` στο git είναι εφιάλτης
  * Αργότερα, όταν τα επίπεδα υποδομής αρχίσουν να αυξάνονται προς πολλές κατευθύνσεις (αριθμός εξαρτήσεων ή πόρων) θα είναι ευκολότερο να κρατήσετε τα πράγματα υπό έλεγχο
* Εφαρμόστε μια συνεπή δομή και [σύμβαση ονομασίας](naming.md):
  * Όπως και ο διαδικαστικός κώδικας, ο κώδικας Terraform θα πρέπει να γράφεται πρώτα για να τον διαβάζουν οι άνθρωποι, η συνέπεια θα βοηθήσει όταν θα γίνουν αλλαγές σε έξι μήνες από τώρα.
  * Είναι δυνατή η μετακίνηση πόρων στο αρχείο κατάστασης Terraform, αλλά μπορεί να είναι πιο δύσκολο να γίνει αν έχετε ασυνεπή δομή και ονοματοδοσία
* Διατηρήστε τις ενότητες πόρων όσο το δυνατόν πιο απλές
* Μην γράφετε hardcoded τιμές που μπορούν να περάσουν ως μεταβλητές ή να ανακαλυφθούν με τη χρήση πηγών δεδομένων
* Χρησιμοποιήστε τις πηγές δεδομένων και το `terraform_remote_state` ειδικά ως "συγκολλητικό υλικό" μεταξύ των μονάδων υποδομής εντός της σύνθεσης&#x20;

Σε αυτό το βιβλίο τα παραδείγματα έργων ομαδοποιούνται ανάλογα με την _πολυπλοκότητα_ - από μικρές έως πολύ μεγάλες υποδομές. Αυτός ο διαχωρισμός δεν είναι αυστηρός, οπότε ελέγξτε και άλλες δομές.

### Ενορχήστρωση μονάδων υποδομής και συνθέσεων

Η ύπαρξη μιας μικρής υποδομής σημαίνει ότι υπάρχει μικρός αριθμός εξαρτήσεων και λίγοι πόροι. Καθώς το έργο μεγαλώνει, γίνεται εμφανής η ανάγκη για την αλυσιδωτή εκτέλεση των ρυθμίσεων του Terraform, τη σύνδεση διαφορετικών μονάδων υποδομής και τη μεταβίβαση τιμών εντός μιας σύνθεσης.

Υπάρχουν τουλάχιστον 5 διακριτές ομάδες λύσεων ενορχήστρωσης που χρησιμοποιούν οι προγραμματιστές:

1. Μόνο Terraform. Πολύ απλό, οι προγραμματιστές πρέπει να γνωρίζουν μόνο το Terraform για να κάνουν τη δουλειά τους.
2. Terragrunt. Καθαρό εργαλείο ενορχήστρωσης το οποίο μπορεί να χρησιμοποιηθεί για την ενορχήστρωση ολόκληρης της υποδομής καθώς και για το χειρισμό των εξαρτήσεων. Το Terragrunt λειτουργεί με ενότητες υποδομής και συνθέσεις εγγενώς, οπότε μειώνει την επανάληψη του κώδικα.
3. Εσωτερικά scripts. Συχνά αυτό συμβαίνει ως σημείο εκκίνησης προς την ενορχήστρωση και πριν την ανακάλυψη του Terragrunt.
4. Ansible ή παρόμοιο εργαλείο αυτοματοποίησης γενικού σκοπού. Συνήθως χρησιμοποιείται όταν το Terraform υιοθετείται μετά το Ansible ή όταν χρησιμοποιείται ενεργά το Ansible UI.
5. [Crossplane](https://crossplane.io/) και άλλες λύσεις εμπνευσμένες από το Kubernetes. Μερικές φορές έχει νόημα να αξιοποιήσετε το οικοσύστημα Kubernetes και να χρησιμοποιήσετε μια λειτουργία βρόχου «συμφιλίωσης» για να επιτύχετε την επιθυμητή κατάσταση των ρυθμίσεων του Terraform σας. Δείτε το βίντεο [Crossplane vs Terraform](https://www.youtube.com/watch?v=ELhVbSdcqSY) για περισσότερες πληροφορίες.

Έχοντας αυτό κατά νου, αυτό το βιβλίο εξετάζει τις δύο πρώτες από αυτές τις δομές έργων, το Terraform only και το Terragrunt.&#x20;

Δείτε παραδείγματα δομών κώδικα για [Terraform](examples/terraform/) ή [Terragrunt](examples/terragrunt.md) στο επόμενο κεφάλαιο.
